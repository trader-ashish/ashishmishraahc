//@version=5
indicator("AI Price Action S/R + Breakout Dashboard (clean)", overlay=true, max_lines_count=500, max_labels_count=500)

// ----- INPUTS -----
leftBars     = input.int(5, "Pivot Left Bars", minval=1)
rightBars    = input.int(5, "Pivot Right Bars", minval=1)
maxZones     = input.int(10, "Max Zones", minval=1, maxval=50)
zoneATRFrac  = input.float(0.20, "Zone size (ATR fraction)", step=0.01, minval=0.01, maxval=1.0)
showZones    = input.bool(true, "Show S/R Zones")
showDash     = input.bool(true, "Show Dashboard")
showBreakouts= input.bool(true, "Show Breakouts")

// ----- STORAGE -----
var float[] zones = array.new_float()
var box[]   boxes = array.new_box()

atr = ta.atr(14)
tol = atr * 0.30

// ----- PIVOT DETECTION -----
ph = ta.pivothigh(high, leftBars, rightBars)
pl = ta.pivotlow(low, leftBars, rightBars)

// ----- ADD ZONE FUNCTION (safe checks) -----
f_add_zone(_price, _isSupport) =>
    duplicate = false
    if array.size(zones) > 0
        for i = 0 to array.size(zones) - 1
            if math.abs(array.get(zones, i) - _price) <= tol
                duplicate := true
    if not duplicate
        array.push(zones, _price)
        if showZones
            half = atr * zoneATRFrac
            top = _price + half
            bottom = _price - half
            col = _isSupport ? color.new(color.blue, 80) : color.new(color.red, 80)
            b = box.new(bar_index - rightBars, top, bar_index, bottom, xloc = xloc.bar_index, border_width = 0, bgcolor = col, extend = extend.right)
            array.push(boxes, b)
        if array.size(zones) > maxZones
            oldBox = array.shift(boxes)
            box.delete(oldBox)
            array.shift(zones)

// ----- WHEN PIVOTS APPEAR, ADD ZONES -----
if not na(ph)
    f_add_zone(ph, false)  // resistance
if not na(pl)
    f_add_zone(pl, true)   // support

// ----- TREND / SIGNALS -----
ema20 = ta.ema(close, 20)
ema50 = ta.ema(close, 50)
trendUp   = ema20 > ema50
trendDown = ema20 < ema50
buySignal  = ta.crossover(ema20, ema50)
sellSignal = ta.crossunder(ema20, ema50)

// ----- BREAKOUT DETECTION (compute only, plotting outside) -----
breakoutUp = false
breakoutDn = false
if array.size(zones) > 0
    for i = 0 to array.size(zones) - 1
        lvl = array.get(zones, i)
        if ta.crossover(close, lvl)
            breakoutUp := true
        if ta.crossunder(close, lvl)
            breakoutDn := true

// ----- PLOTTING (global scope) -----
plotshape(buySignal,  title="Buy",  style=shape.triangleup,   location=location.belowbar, color=color.green, size=size.large)
plotshape(sellSignal, title="Sell", style=shape.triangledown, location=location.abovebar, color=color.red, size=size.large)

plotshape(showBreakouts and breakoutUp,  title="Breakout Up",   style=shape.arrowup,   location=location.abovebar, color=color.lime,  size=size.small)
plotshape(showBreakouts and breakoutDn,  title="Breakout Down", style=shape.arrowdown, location=location.belowbar, color=color.maroon, size=size.small)

// ----- DASHBOARD -----
if showDash
    var table dash = table.new(position.top_right, 2, 3, border_width = 1)
    // header + values arranged as (column, row)
    table.cell(dash, 0, 0, "Trend", text_color=color.white, bgcolor=color.black)
    table.cell(dash, 1, 0, trendUp ? "UP" : trendDown ? "DOWN" : "SIDE", text_color=color.white, bgcolor = trendUp ? color.green : trendDown ? color.red : color.gray)

    table.cell(dash, 0, 1, "Signal", text_color=color.white, bgcolor=color.black)
    table.cell(dash, 1, 1, buySignal ? "BUY" : sellSignal ? "SELL" : "WAIT", text_color=color.white, bgcolor = buySignal ? color.green : sellSignal ? color.red : color.gray)

    table.cell(dash, 0, 2, "Breakout", text_color=color.white, bgcolor=color.black)
    table.cell(dash, 1, 2, breakoutUp ? "UP" : breakoutDn ? "DOWN" : "-", text_color=color.white, bgcolor = breakoutUp ? color.lime : breakoutDn ? color.red : color.gray)

// ----- ALERTS -----
alertcondition(buySignal,  title="Buy Alert", message="Buy signal")
alertcondition(sellSignal, title="Sell Alert", message="Sell signal")
alertcondition(breakoutUp, title="Breakout Up Alert", message="Breakout Up")
alertcondition(breakoutDn, title="Breakout Down Alert", message="Breakout Down")
